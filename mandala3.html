<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Majestic Mandala Music Visualizer</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
    canvas{display:block;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
</head>
<body>
<script>
let fft, audio, mic;
let useMic = false;

function setup(){
  createCanvas(windowWidth, windowHeight);
  angleMode(DEGREES);
  colorMode(HSB, 360, 100, 100, 100);
  fft = new p5.FFT(0.9, 4096);
  noFill();

  let fileInput = createFileInput(handleFile);
  fileInput.position(10, 10);

  let micBtn = createButton('Toggle Mic');
  micBtn.position(10, 40);
  micBtn.mousePressed(toggleMic);
}

function handleFile(file){
  if(file.type === 'audio'){
    if(audio && audio.isPlaying()) audio.stop();
    audio = loadSound(file.data, () => {
      fft.setInput(audio);
      audio.play();
    });
  }
}

function toggleMic(){
  if(!useMic){
    mic = new p5.AudioIn();
    mic.start();
    fft.setInput(mic);
    useMic = true;
  } else {
    if(mic) mic.stop();
    useMic = false;
    if(audio) fft.setInput(audio);
  }
}

function draw(){
  background(40, 80, 5, 10);
  translate(width/2, height/2);

  let spectrum = fft.analyze();
  let bass = fft.getEnergy('bass');
  let mid = fft.getEnergy('mid');
  let treble = fft.getEnergy('treble');

  let layers = 24;
  let symmetry = 36;
  let maxR = min(width, height) / 2.2;

  for(let l=0; l<layers; l++){
    push();
    rotate(frameCount * 0.1 * (l%2 ? 1 : -1));
    let rFactor = map(l, 0, layers, 0.1, 1);
    let hue = (frameCount*0.5 + l*15) % 360;
    stroke(hue, 80, 100, 60);
    strokeWeight(1.5);
    beginShape();
    for(let i=0; i<symmetry; i++){
      let angle = map(i, 0, symmetry, 0, 360);
      let specIndex = floor(map(i, 0, symmetry, 0, spectrum.length-1));
      let radius = map(spectrum[specIndex], 0, 255, 50, maxR * rFactor);
      radius += sin(frameCount*1.5 + i*8) * bass * 0.1;
      radius += cos(frameCount*0.8 + i*4) * mid * 0.05;
      let x = radius * cos(angle);
      let y = radius * sin(angle);
      curveVertex(x, y);
    }
    endShape(CLOSE);
    pop();
  }

  // Fractal-like inner detail
  for(let r = 20; r < maxR; r += 25){
    push();
    rotate(frameCount * 0.05 * (r%50===0 ? -1 : 1));
    stroke((frameCount + r) % 360, 60, 100, 40);
    ellipse(0, 0, r + bass*0.3, r + bass*0.3);
    pop();
  }

  // Radiating particle bursts
  strokeWeight(1);
  for(let a=0; a<360; a+=3){
    let r = map(sin(frameCount*0.5 + a), -1, 1, 50, maxR);
    let alpha = map(treble, 0, 255, 10, 80);
    stroke((a + frameCount) % 360, 80, 100, alpha);
    point(r * cos(a), r * sin(a));
  }
}
</script>
</body>
</html>
